<!DOCTYPE html>
<html lang="en" dir="">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Nuevo Caso</title>
    <link href="https://fonts.googleapis.com/css?family=Nunito:300,400,400i,600,700,800,900" rel="stylesheet" />
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <link href="/dist-assets/css/themes/lite-purple.min.css" rel="stylesheet" />
    <link href="/dist-assets/css/plugins/perfect-scrollbar.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">



</head>

<body class="text-left">
    <div class="app-admin-wrap layout-horizontal-bar">
        <div class="main-header">
            <div class="logo"><img src="/dist-assets/images/logo.png" alt="" /></div>
            <div class="menu-toggle">
                <div></div>
                <div></div>
                <div></div>
            </div>
            <div class="d-flex align-items-center">
               
            </div>
            <div style="margin: auto">
                
            </div>
            <div class="header-part-right">  
                <h4 class="mt-3 mr-3 " id="userNameDisplay"></h4> 
                <a class="link-icon mr-1" href="/index.html" style="font-size:xx-large; color: brown;"><i class="fa-solid fa-power-off"></i></a>
            </div>
        </div>
        
        <!-- header top menu end-->
        <div class="horizontal-bar-wrap">
            <div class="header-topnav">
                <div class="container-fluid bar-views">
                    <div class="topnav rtl-ps-none" id="" data-perfect-scrollbar="" data-suppress-scroll-x="true">
                        <ul class="menu float-left">
                            <li class="views" id="nuevoCaso">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Nuevo caso</label>
                                        <a href="nuevoCaso.html"><i class="nav-icon mr-2 i-Library text-white"></i> <span class="text-white">Nuevo caso</span> </a>
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="casosPendientes">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Mesa de Entrada</label><a href="casosPendientes.html"><i class="nav-icon i-File-Horizontal-Text mr-2 text-white"></i> <span class="text-white">Mesa de Entrada</span></a>
                                       
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="casosGestion">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Casos en Gestión</label>
                                        <a href="casosEnGestion.html"><i class="nav-icon mr-2 i-Receipt text-white"></i><span class="text-white">Casos en Gestión</span></a>
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="baseUnica">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Base única</label>
                                        <a href="baseUnica.html"><i class="nav-icon i-File-Horizontal-Text mr-2 text-white"></i> <span class="text-white">Base única</span></a>
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="estadisticas">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Estadísticas</label>
                                        <a href="estadisticas.html"><i class="nav-icon mr-2 i-Bar-Chart-5 text-white"></i> <span class="text-white">Estadísticas</span></a>
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="facturacion">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Facturación</label>
                                        <a href="facturacion.html"><i class="nav-icon mr-2 i-Windows-2 text-white"></i><span class="text-white">Facturación</span></a>
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="casosPas">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Mis Casos</label>
                                        <a href="casosPas.html"><i class="nav-icon i-File-Horizontal-Text mr-2 text-white"></i> <span class="text-white">Mis Casos</span></a>
                                    </div>
                                </div>
                            </li>
                            <li class="views" id="novedades">
                                <div>
                                    <div>
                                        <label class="toggle" for="drop-2">Información Útil</label>
                                        <a href="novedades.html"><i class="nav-icon i-File-Horizontal-Text mr-2 text-white"></i> <span class="text-white">Novedades</span></a>
                                    </div>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <!-- =============== Horizontal bar End ================-->
        <div class="main-content-wrap d-flex flex-column">
            <!-- ============ Body content start ============= -->
            <div class="main-content">
                <div class="row mb-4">
                    <!-- <div class="col-md-12 d-flex justify-content-end"> 
                        <button id="authorize_button" class="btn btn-secondary" onclick="handleAuthClick()">A</button>
                    </div> -->
                </div>
                <div class="inbox-main-sidebar-container" data-sidebar-container="main">
                    <div class="inbox-main-content" data-sidebar-content="main">
                        <!-- SECONDARY SIDEBAR CONTAINER-->
                        <div class="inbox-secondary-sidebar-container box-shadow-1" data-sidebar-container="secondary">
                            <div data-sidebar-content="secondary">
                                <div class="inbox-secondary-sidebar-content position-relative" style="min-height: 500px">
                                    <div class="inbox-topbar box-shadow-1 perfect-scrollbar rtl-ps-none pl-3" data-suppress-scroll-y="true">
                                        <a class="link-icon d-md-none" data-sidebar-toggle="main"><i class="icon-regular i-Arrow-Turn-Left"></i></a><a class="link-icon mr-3 d-md-none" data-sidebar-toggle="secondary"><i class="icon-regular mr-1 i-Left-3"></i> </a>
                                        <div class="d-flex">     
                                          <a class="link-icon mr-3" id="saveChanges" onclick="uploadFiles(event)" style="cursor: pointer;"><i class="icon-regular i-Mail-Password"></i> Guardar</a><a class="link-icon mr-3" id='sendWhatsApp' style="cursor: pointer;"><i class="icon-regular i-Mail-Send"></i> Notificar a cliente</a> </div>
                                    </div>
                                    <div class="row">
                                    <div class="col-md-6">
                                    <div class="form-floating">
                                        <textarea class="form-control" placeholder="Escribir..." id="actualizacion" style="height: 100px"></textarea>
                                      </div>
                                   <div>
                                    <div class="form-check form-check-inline mt-5">
                                        <label class="checkbox checkbox-outline-info">
                                          
                                        </label>
                                      </div>
                                     
                                   </div>
                                   
                                   <div class="input-group mb-3" id="1" >
                                    <label class="input-group-text" for="inputGroupFile01">DNI (frente)</label>
                                    <input type="file" class="form-control" id="adjDniFrente">
                                  </div>
                                  <div class="input-group mb-3" id="2" >
                                    <label class="input-group-text" for="inputGroupFile01">DNI (dorso)</label>
                                    <input type="file" class="form-control" id="adjDniDorso">
                                  </div>
                                  <div class="input-group mb-3" id="3" >
                                    <label class="input-group-text" for="inputGroupFile01">Registro (frente)</label>
                                    <input type="file" class="form-control" id="adjRegistroFrente">
                                  </div>
                                  <div class="input-group mb-3" id="4" >
                                    <label class="input-group-text" for="inputGroupFile01">Registro (dorso)</label>
                                    <input type="file" class="form-control" id="adjRegistroDorso">
                                  </div>
                                  <div class="input-group mb-3" id="5" >
                                    <label class="input-group-text" for="inputGroupFile01">Cédula Verde (Frente)</label>
                                    <input type="file" class="form-control" id="adjCedulaVerdeFrente">
                                  </div>
                                  <div class="input-group mb-3" id="6" >
                                    <label class="input-group-text" for="inputGroupFile01">Cédula Verde (Dorso)</label>
                                    <input type="file" class="form-control" id="adjCedulaVerdeDorso">
                                  </div>
                                  <div class="input-group mb-3" id="7" >
                                    <label class="input-group-text" for="inputGroupFile01">Denuncia Administrativa</label>
                                    <input type="file" class="form-control" id="adjDenunciaAdm">
                                  </div>
                                  <div class="input-group mb-3" id="8" >
                                    <label class="input-group-text" for="inputGroupFile01">Certificado de cobertura</label>
                                    <input type="file" class="form-control" id="adjCertCobertura">
                                  </div>
                                  <div class="input-group mb-3" id="9" >
                                    <label class="input-group-text" for="inputGroupFile01">Foto Siniestro</label>
                                    <input type="file" class="form-control" id="adjFotoSiniestro">
                                  </div>
                                  <div class="input-group mb-3" id="10" >
                                    <label class="input-group-text" for="inputGroupFile01">Presupuesto</label>
                                    <input type="file" class="form-control" id="adjPresupuesto">
                                  </div>
                                  <div class="input-group mb-3" id="11" >
                                    <label class="input-group-text" for="inputGroupFile01">Contrato Social</label>
                                    <input type="file" class="form-control" id="adjContratoSoc">
                                  </div>

                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <textarea class="form-control" placeholder="Historial..." id="historial" style="height: 100px" disabled></textarea>
                                  </div>
                               <div>
                                <!-- que las compañias se cargen dinamicamente desde la base -->
                               </div>
                             <div class="">
                                <div class="input-group mt-2 mb-3">
                                    <div class="input-group-prepend "><span class="input-group-text" >Teléfono</span></div>
                                    <input class="form-control" id="telefono" type="text" aria-describedby="basic-addon3" />
                                </div>
                                <div class="input-group mt-2 mb-3">
                                    <div class="input-group-prepend "><span class="input-group-text" >Mail</span></div>
                                    <input class="form-control" id="email" type="text" aria-describedby="basic-addon3" />
                                </div>
                                <div class="input-group mt-2 mb-3">
                                    <div class="input-group-prepend "><span class="input-group-text" >Observación</span></div>
                                    <input class="form-control" id="obs" type="text" aria-describedby="basic-addon3" />
                                </div>
                                <div class="input-group mt-2 mb-3 mt-4">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Estado</span>
                                    </div>
                                    <!-- Convierte el input en un select -->
                                    <select class="form-control" id="estado"></select>
                                </div>
                             </div>

                        </div>
                            </div>
                         </div>
                        </div>
                    </div>
                            </div>
                            <!-- Secondary Inbox sidebar-->
                            <div class="inbox-secondary-sidebar perfect-scrollbar rtl-ps-none" data-sidebar="secondary"><i class="sidebar-close i-Close" data-sidebar-toggle="secondary"></i>
                                <div class="input-group mt-2 mb-3 mt-4">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">PAS</span>
                                    </div>
                                    <!-- Convierte el input en un select -->
                                    <select class="form-control" id="pasDropdown"></select>
                                </div>
                                <div class="input-group mt-2 mb-3">
                                    <div class="input-group-prepend "><span class="input-group-text" >Cliente</span></div>
                                    <input class="form-control" id="cliente" type="text" aria-describedby="basic-addon3" />
                                </div>
                                <div class="input-group mt-2 mb-3">
                                    <div class="input-group-prepend "><span class="input-group-text" >Fecha de ingreso</span></div>
                                    <input class="form-control" id="ingreso" type="text" aria-describedby="basic-addon3" />
                                </div>
                                <div class="input-group mt-2 mb-3">
                                    <div class="input-group-prepend "><span class="input-group-text" >Dominio</span></div>
                                    <input class="form-control" id="dominio" type="text" aria-describedby="basic-addon3" />
                                </div>
                                <div class="input-group mt-2 mb-3 mt-4">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">CIA a Reclamar</span>
                                    </div>
                                    <!-- Convierte el input en un select -->
                                    <select class="form-control" id="ciaReclamar"></select>
                                </div>
                                <div class="input-group mt-2 mb-3 mt-4">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">Tipo de Reclamo</span>
                                    </div>
                                    <!-- Convierte el input en un select -->
                                    <select class="form-control" id="tipoReclamo"></select>
                                </div>

                            </div>
                        </div>
                    </div>
                    <!-- MAIN INBOX SIDEBAR-->
                </div>
  
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        
        document.addEventListener('DOMContentLoaded', () => {
            const userData = JSON.parse(localStorage.getItem('userData'));
        
            if (userData) {
                const permission = userData.permission; // Asumimos que este es un string con el permiso del usuario
                const name = userData.name;
                document.getElementById('userNameDisplay').innerText = `${userData.name}`;
                // Ocultar todas las pestañas inicialmente
                document.querySelectorAll('.views').forEach(view => {
                    view.style.display = 'none'; // Ocultar todas las pestañas
                });
        
                // Mostrar pestañas basadas en permisos
                if (permission === 'super usuario') {
                    document.getElementById('nuevoCaso').style.display = 'block';
                    document.getElementById('casosPendientes').style.display = 'block';
                    document.getElementById('casosGestion').style.display = 'block';
                    document.getElementById('baseUnica').style.display = 'block';
                    document.getElementById('estadisticas').style.display = 'block';
                    document.getElementById('facturacion').style.display = 'block';
                    document.getElementById('casosPas').style.display = 'block';
                    document.getElementById('novedades').style.display = 'block';
                } else if (permission === 'ejecutivo') {
                    document.getElementById('nuevoCaso').style.display = 'block';
                    document.getElementById('casosGestion').style.display = 'block';
                    document.getElementById('baseUnica').style.display = 'block';
                    document.getElementById('estadisticas').style.display = 'block';
                } else if (permission === 'mesa de entrada') {
                    document.getElementById('nuevoCaso').style.display = 'block';
                    document.getElementById('casosPendientes').style.display = 'block';
                } else if (permission === 'mediacion') {
                    document.getElementById('nuevoCaso').style.display = 'block';
                    document.getElementById('casosGestion').style.display = 'block';
                    document.getElementById('baseUnica').style.display = 'block';
                    document.getElementById('estadisticas').style.display = 'block';
                }else if (permission === 'jefe de operaciones') {
                    document.getElementById('nuevoCaso').style.display = 'block';
                    document.getElementById('casosGestion').style.display = 'block';
                    document.getElementById('baseUnica').style.display = 'block';
                    document.getElementById('estadisticas').style.display = 'block';

                }else if (permission === 'PAS') {
                    document.getElementById('casosPas').style.display = 'block';
                    document.getElementById('novedades').style.display = 'block';

                }else if (permission === 'LEGALES') {
                    document.getElementById('casosGestion').style.display = 'block';
                    document.getElementById('baseUnica').style.display = 'block';
                }else if (permission === 'FACTURACION') {
                    document.getElementById('facturacion').style.display = 'block';
                    document.getElementById('estadisticas').style.display = 'block';
                }
            } else {
                // Si no hay información de usuario, redirigir a login
                window.location.href = 'index.html';
            }
        });

        const CLIENT_ID = '607561137784-rq84r06gop7p4hjo1nnv0q5re4fl2nff.apps.googleusercontent.com';
const API_KEY = 'AIzaSyBLuMXUjJmU3XLfErAIH-iI4pXzmSnl-0E';
const DISCOVERY_DOCS = [
    'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
    'https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest'
];
const SCOPES = 'https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/spreadsheets';
let tokenClient;
let gapiInited = false;
let gisInited = false;

function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: DISCOVERY_DOCS,
    });
    gapiInited = true;

    // Intentar autenticar automáticamente
    attemptSilentAuth();
}

function gisLoaded() {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
            if (resp.error !== undefined) {
                console.error('Error durante la autenticación:', resp.error);
                return;
            }
        }
    });
    gisInited = true;
}

async function attemptSilentAuth() {
    const storedToken = localStorage.getItem('google_access_token');

    if (storedToken) {
        // Establecer el token almacenado en el cliente de gapi
        gapi.client.setToken({ access_token: storedToken });
        try {
            // Intentar un llamado de prueba para verificar si el token sigue siendo válido
    
            console.log('Autenticación silenciosa exitosa.');
            return;
        } catch (err) {
            console.error('Token expirado o inválido. Reautenticando...', err);
        }
    }

    // Si el token no es válido o no existe, solicitar autenticación
    handleAuthClick();
}

function handleAuthClick() {
    tokenClient.callback = async (resp) => {
        if (resp.error !== undefined) {
            console.error('Error durante la autenticación:', resp.error);
            return;
        }

        // Almacenar el token en localStorage
        const accessToken = gapi.client.getToken().access_token;
        localStorage.setItem('google_access_token', accessToken);

        console.log('Token guardado en localStorage.');

    };

    if (gapi.client.getToken() === null) {
        tokenClient.requestAccessToken({ prompt: '' }); // Autenticación silenciosa
    } else {
        tokenClient.requestAccessToken({ prompt: '' });
    }
}

function handleSignoutClick() {
    const token = gapi.client.getToken();
    if (token !== null) {
        google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken('');
            localStorage.removeItem('google_access_token'); // Eliminar el token almacenado
            console.log('Sesión cerrada.');
        });
    }
}
const spreadsheetId = '1gzp1hLfZaZMQarKdxPnvtHeyTioqhd3vatL-UmFnlUI';
const spreadsheetId2 = '1FdJtx_Dr8dgvC-9HWfckT8qzHm8BikoSbV9EORXSEb8';
const apiKey = 'AIzaSyBLuMXUjJmU3XLfErAIH-iI4pXzmSnl-0E'; //  clave de API
const range = 'sheet1'; // 
const range2 = 'Hoja 1'; // 
const range3 = 'Hoja 2'; // 
const range4 = 'Hoja 3'; // 

// URL de la API de Google Sheets
const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?key=${apiKey}`;
const url2 = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId2}/values/${range2}?key=${apiKey}`;
const url3 = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId2}/values/${range3}?key=${apiKey}`;
const url4 = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId2}/values/${range4}?key=${apiKey}`;

document.addEventListener('DOMContentLoaded', function() {
    // Inicializa Select2 en el elemento select
    $('#pasDropdown').select2({
        placeholder: 'Seleccione un nombre',
        allowClear: true,
        width: '100%'
    });

    // Realiza la solicitud fetch para obtener datos dinámicos
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const rows = data.values;
            console.log(rows);

            // Extrae los nombres de la tercera columna (índice [2]), excluyendo la primera fila (cabeceras)
            const selectedRows = rows.slice(1).map(row => row[2]);
            
            // Prepara la lista dinámica en el formato que Select2 espera (id y text)
            const listaDinamica = selectedRows.map((nombre, index) => ({
                id: nombre,
                text: nombre
            }));

            console.log('Lista Dinámica:', listaDinamica);

            // Cargar la lista dinámica en el dropdown
            $('#pasDropdown').select2({
                data: listaDinamica
            });
        })
        .catch(error => console.error('Error al cargar datos', error));
        
       fetch(url2)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const rows = data.values;
            console.log(rows);

            // Extrae los nombres de la tercera columna (índice [2]), excluyendo la primera fila (cabeceras)
            const selectedRows = rows.slice(1).map(row => row[0]);
            
            // Prepara la lista dinámica en el formato que Select2 espera (id y text)
            const listaDinamica2 = selectedRows.map((nombre, index) => ({
                id: nombre,
                text: nombre
            }));

            console.log('Lista Dinámica:', listaDinamica2);

            // Cargar la lista dinámica en el dropdown
            $('#ciaReclamar').select2({
                data: listaDinamica2
            });
        })
        .catch(error => console.error('Error al cargar datos', error));
        fetch(url3)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const rows = data.values;
            console.log(rows);

            // Extrae los nombres de la tercera columna (índice [2]), excluyendo la primera fila (cabeceras)
            const selectedRows = rows.slice(1).map(row => row[0]);
            
            // Prepara la lista dinámica en el formato que Select2 espera (id y text)
            const listaDinamica3 = selectedRows.map((nombre, index) => ({
                id: nombre,
                text: nombre
            }));

            console.log('Lista Dinámica:', listaDinamica3);

            // Cargar la lista dinámica en el dropdown
            $('#estado').select2({
                data: listaDinamica3
            });
        })
        .catch(error => console.error('Error al cargar datos', error));
        fetch(url4)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            const rows = data.values;
            console.log(rows);

            // Extrae los nombres de la tercera columna (índice [2]), excluyendo la primera fila (cabeceras)
            const selectedRows = rows.slice(1).map(row => row[0]);
            
            // Prepara la lista dinámica en el formato que Select2 espera (id y text)
            const listaDinamica3 = selectedRows.map((nombre, index) => ({
                id: nombre,
                text: nombre
            }));

            console.log('Lista Dinámica:', listaDinamica3);

            // Cargar la lista dinámica en el dropdown
            $('#tipoReclamo').select2({
                data: listaDinamica3
            });
        })
        .catch(error => console.error('Error al cargar datos', error));

});

async function uploadFiles(e) {
    e.preventDefault();
    
    const fileIds = [
        'adjDniFrente',
        'adjDniDorso',
        'adjRegistroFrente',
        'adjRegistroDorso',
        'adjCedulaVerdeFrente',
        'adjCedulaVerdeDorso',
        'adjDenunciaAdm',
        'adjCertCobertura',
        'adjFotoSiniestro',
        'adjPresupuesto',
        'adjContratoSoc',
    ];
    console.log(fileIds);
    const urls = [];

    // Aquí debes definir el ID de la carpeta donde se guardarán los archivos
    const parentFolderId = await createFolderInDynamicParent(); 

    for (const fileId of fileIds) {
        const fileInput = document.getElementById(fileId);
        const file = fileInput.files[0];

        if (file) {
            const url = await uploadFile(file, parentFolderId.folderId);
            if (url) {
                urls.push(url);
            } else {
                console.error(`Error al subir ${fileId}`);
            }
        } else {
            urls.push(''); // Si no hay archivo, guarda null
        }
    }
    console.log(urls);
    await saveDataToSheetWithFiles(urls,parentFolderId.folderUrl);
}

async function uploadFile(file, parentFolderId) {
    const metadata = {
        'name': file.name,
        'mimeType': file.type,
        'parents': [parentFolderId] // Especificar la carpeta padre
    };

    const formData = new FormData();
    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    formData.append('file', file);

    try {
        const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
            method: 'POST',
            headers: new Headers({ 'Authorization': 'Bearer ' + gapi.client.getToken().access_token }),
            body: formData
        });

        if (response.ok) {
            const result = await response.json();
            const fileURL = `https://drive.google.com/file/d/${result.id}/view?usp=sharing`;
            alert(`Archivo ${file.name} subido con éxito. ID: ${result.id}`);
            return fileURL;
        } else {
            console.error('Error al subir archivo:', response.statusText);
        }
    } catch (error) {
        console.error('Error al subir archivo:', error);
    }
    return null; // En caso de error
}
async function createFolderInDynamicParent() {
    const parentFolderName = document.getElementById('pasDropdown').value;
    const newFolderName = document.getElementById('cliente').value;
    console.log(parentFolderName);
    console.log(newFolderName);

    try {
        // 1. Buscar la carpeta padre en Drive por nombre
        const parentResponse = await gapi.client.drive.files.list({
            q: `name='${parentFolderName}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,
            fields: 'files(id, name, webViewLink)'
        });

        console.log('parentResponse', parentResponse);

        if (parentResponse.result.files.length === 0) {
            console.error("No se encontró la carpeta padre especificada.");
            return null;
        }

        // Selecciona el primer resultado de búsqueda como la carpeta padre
        const parentFolder = parentResponse.result.files[0];
        console.log("Carpeta padre encontrada:", parentFolder);

        // 2. Crear la nueva carpeta dentro de la carpeta padre
        const newFolderBody = {
            name: newFolderName,
            mimeType: 'application/vnd.google-apps.folder',
            parents: [parentFolder.id]
        };

        const createResponse = await gapi.client.drive.files.create({
            resource: newFolderBody,
            fields: 'id, name, parents, webViewLink'
        });

        if (createResponse.status === 200) {
            const newFolder = createResponse.result;
            console.log("Carpeta creada exitosamente:", newFolder);
            console.log("ID de la nueva carpeta:", newFolder.id);
            console.log("Enlace a la carpeta:", newFolder.webViewLink);
            const folderUrl =  newFolder.webViewLink;
            const folderId = newFolder.id;
          
            // Retorna el webViewLink de la nueva carpeta creada
            return  {
                folderUrl,
                folderId
            
            }
        } else {
            console.error("Error al crear la carpeta:", createResponse);
            return null;
        }
    } catch (error) {
        console.error("Error en la solicitud:", error);
        return null;
    }
}
async function saveDataToSheetWithFiles(urls,folderUrl) {

    // Datos para las columnas de A a H
    const valuesAtoH = [
        document.getElementById('ingreso') ? document.getElementById('ingreso').value : "",
        document.getElementById('pasDropdown') ? document.getElementById('pasDropdown').value : "",
        document.getElementById('cliente') ? document.getElementById('cliente').value : "",
        document.getElementById('dominio') ? document.getElementById('dominio').value : "",
        document.getElementById('ciaReclamar') ? document.getElementById('ciaReclamar').value : "",
        document.getElementById('telefono') ? document.getElementById('telefono').value : "",
        document.getElementById('email') ? document.getElementById('email').value : "",
        document.getElementById('obs') ? document.getElementById('obs').value : "",
    ];
    console.log(valuesAtoH)
    // URLs de archivos adjuntos para llenar de I a S
    const filledUrls = urls.map(url => url || ''); // Reemplaza los valores vacíos con ''
    while (filledUrls.length < 11) {
        filledUrls.push(''); // Asegura que haya exactamente 11 columnas en I:S
    }

    // Datos para las columnas de T a V
    const valuesTtoW = [
        document.getElementById('tipoReclamo') ? document.getElementById('tipoReclamo').value : "",
        document.getElementById('actualizacion') ? document.getElementById('actualizacion').value : "",
        document.getElementById('estado') ? document.getElementById('estado').value : "",
        folderUrl || "",
    ];

    // Combina todos los valores en un solo array
    const values = [...valuesAtoH, ...filledUrls, ...valuesTtoW];

    const spreadsheetId = '1QzbFeGvzlzxVYN53G_5Dkl7Lji41Q6_0iMCqhVJhHhs'; // Reemplaza con tu ID de hoja de cálculo
    const range = `Respuestas de formulario 1!A:W`; // Especifica todo el rango de A a V

    const body = {
        values: [values] // Agrega la fila combinada
    };

    try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}:append?valueInputOption=USER_ENTERED`, {
            method: 'POST', // Cambia a 'POST' para usar el método 'append'
            headers: new Headers({
                'Authorization': 'Bearer ' + gapi.client.getToken().access_token,
                'Content-Type': 'application/json'
            }),
            body: JSON.stringify(body)
        });

        if (response.ok) {
           // await createFolderInDynamicParent()
            const result = await response.json();
            Swal.fire({
  title: '¡Éxito!',
  text: 'El caso se guardo correctamente.',
  icon: 'success', // Puede ser 'success', 'error', 'warning', 'info', 'question'
  confirmButtonText: 'Aceptar',
}).then((result) => {
  if (result.isConfirmed) {
    window.location.href = '/html/casosPendientes.html';
  }
});
            console.log('Fila guardada con éxito:', result);
        } else {
            Swal.fire({
  title: '¡ERROR!',
  text: 'El caso no pudo guardarse.',
  icon: 'error', // Puede ser 'success', 'error', 'warning', 'info', 'question'
  confirmButtonText: 'Aceptar'
})
            console.error('Error al guardar la fila:', response.statusText);
        }
    } catch (error) {
        Swal.fire({
  title: '¡ERROR!',
  text: 'El caso no pudo guardarse.',
  icon: 'error', // Puede ser 'success', 'error', 'warning', 'info', 'question'
  confirmButtonText: 'Aceptar'
});
        console.error('Error al guardar la fila:', error);
    }
}

document.getElementById('sendWhatsApp').addEventListener('click', function() {
    const phoneForm = document.getElementById('telefono').value
    const mensaje = document.getElementById('actualizacion').value;
    const cliente = document.getElementById('cliente').value;
    const pas = document.getElementById('pasDropdown').value;

    console.log(mensaje)
    const phoneNumber = phoneForm; // Reemplaza con el número de teléfono completo
    const message = `Estimado/a ${cliente} nos comunicamos de IN ITINERE, servicio de gestión de siniestros del productor de seguros ${pas} para mantenerlo informado: ${mensaje}`;
    
    // Codificar el mensaje para URL
    const encodedMessage = encodeURIComponent(message);
    
    // Construir la URL
    const whatsappURL = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
    
    // Abrir la URL en una nueva pestaña o ventana
    window.open(whatsappURL, '_blank');
  });





  //   function derivarAEjecutivo(e){
//     e.preventDefault();
//     fetch(url)
//     .then(response => response.json())
//     .then(data => {
//       const rows = data.values; // Supongo que 'values' es el array de filas de Google Sheets

//       // Filtrar por el valor del campo 'pas' y obtener el 'ejecutivo' correspondiente
//       const nameToFind = document.getElementById('pas').value; // El nombre que quieres buscar (sin apellido)
// console.log("NAMETOFIND",nameToFind)
//       // Filtrar por el nombre en la primera columna (suponiendo que 'pas' está en la columna 0)
//       const result = rows.filter(row => {
//           const fullName = row[2]?.trim(); // Asegúrate de eliminar espacios en blanco al inicio y final
//           if (!fullName) return false; // Evita errores si 'fullName' es undefined o null
      
//           const nameToFindStr = String(nameToFind).trim().toLowerCase(); // Elimina espacios y convierte a minúsculas
         
          
//           // Dividir el nombre completo en partes (nombre y apellido)
//           const nameParts = fullName.split(/\s+/); // Usa expresión regular para dividir por espacios
//           console.log("Name Parts:", nameParts);
      
//           // Dividir nameToFind en partes (nombre y apellido)
//           const nameToFindParts = nameToFindStr.split(/\s+/); // Divide el nombre ingresado en partes
//           console.log("NAMETOFIND", nameToFindParts);
//           // Si el nombreToFind tiene más de un nombre (por ejemplo, nombre y apellido), comparamos ambas partes
//           if (nameToFindParts.length > 1) {
//               // Compara nombre y apellido
//               return nameParts.length >= 2 &&
//                   nameParts[0].toLowerCase() === nameToFindParts[0].toLowerCase() && // Comparar primer nombre
//                   nameParts[1].toLowerCase() === nameToFindParts[1].toLowerCase();   // Comparar apellido
//           } else {
//               // Si solo hay un nombre en nameToFind, lo comparamos solo con la primera parte de fullName
//               return nameParts[0].toLowerCase() === nameToFindParts[0].toLowerCase();
//           }
//       });
//         console.log(result)
//       if (result.length > 0) {
//         // Encontramos el ejecutivo en la fila filtrada
//         const ejecutivo = result[0][15]; // Suponiendo que el 'ejecutivo' está en la segunda columna (índice 1)
//         const nroInterno = 'INT0001'
//         console.log('Ejecutivo encontrado:', ejecutivo);
//         saveDataToSheet2((rowIndex+2),ejecutivo,nroInterno);
//       } else {
//         console.log('No se encontró el ejecutivo para el PAS:');
//       }
      
//     })
//     .catch(error => {
//       console.error('Error al obtener los datos:', error);
//     });
   
//     const historialValue = document.getElementById('historial') ? document.getElementById('historial').value : "";
//     const actualizacionValue = document.getElementById('actualizacion') ? document.getElementById('actualizacion').value : "";
    
//     const concatenatedValue = historialValue + " " + actualizacionValue;

    
//     // Extraer valores de los campos del formulario
//     const valuesAtoC = [
//         document.getElementById('ingreso') ? document.getElementById('ingreso').value : "",
//         document.getElementById('pas') ? document.getElementById('pas').value : "",
//        ejecutivo,
//     ];
//     const valuesEtoF = [
//         document.getElementById('cliente') ? document.getElementById('cliente').value : "",
//         document.getElementById('ciaReclamo') ? document.getElementById('ciaReclamo').value : "",
//     ];
//     const valuesHtoJ = [
//         document.getElementById('telefono') ? document.getElementById('telefono').value : "",
//         document.getElementById('email') ? document.getElementById('email').value : "",
//         document.getElementById('obs') ? document.getElementById('obs').value : "",
//     ];

//     // URLs de archivos adjuntos para llenar de K a X
//     // const filledUrls = urls.map(url => url || ''); // Reemplaza los valores vacíos con ''
//     // while (filledUrls.length < 11) {
//     //     filledUrls.push(''); // Asegura que haya exactamente 11 columnas en I:S
//     // }

//     // Datos para las columnas de T a V
//     const valuesYtoZ= [
//         concatenatedValue || "",
//         document.getElementById('inicio') ? document.getElementById('inicio').value : "",
//     ];
   
//     const valuesACtoAF = [
//         document.getElementById('estado') ? document.getElementById('estado').value : "",
//         document.getElementById('tipoReclamo') ? document.getElementById('tipoReclamo').value : "",
//         document.getElementById('montoReclamado') ? document.getElementById('montoReclamado').value : "",
//         document.getElementById('montoCerrado') ? document.getElementById('montoCerrado').value : "",
       
//     ];
//     const valuesAW = [
//         document.getElementById('gestionado') ? document.getElementById('gestionado').value : "",
       
//     ];

//    const rangeesAtoB =  'A10:B10';
//    const rangeesEtoF =  'E10:F10';
//    const rangeesHtoJ =  'H10:J10';
//    const rangeesYtoZ =  'Y10:Z10';
//    const rangeesACtoAF =  'AC10:AF10';
//    const rangeesAW =  'AW10';
// updateRowInSheet( valuesAtoB,rangeesAtoB);
// updateRowInSheet(valuesEtoF, rangeesEtoF );
// updateRowInSheet(valuesHtoJ, rangeesHtoJ );
// updateRowInSheet(valuesYtoZ,rangeesYtoZ);
// updateRowInSheet( valuesACtoAF, rangeesACtoAF);
// updateRowInSheet( valuesAW, rangeesAW);


// }
        </script>
    <!-- ============ Search UI End ============= -->
    <script src="/dist-assets/js/plugins/jquery-3.3.1.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="/dist-assets/js/plugins/bootstrap.bundle.min.js"></script>
    <script src="/dist-assets/js/plugins/perfect-scrollbar.min.js"></script>
    <script src="/dist-assets/js/scripts/script.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <script src="/dist-assets/js/scripts/sidebar-horizontal.script.js"></script>
    <script src="/dist-assets/js/scripts/sidebar.script.min.js"></script> 
  

</body>

</html>